<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Stage ‚Äî Jay Jabiru</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap');

  :root {
    --navy: #050a1a;
    --deep: #080d22;
    --gold: #c9a227;
    --gold-light: #f0c84a;
    --blue: #1e6fb5;
    --blue-light: #4da6f5;
    --cyan: #00d4ff;
    --left-col: #f05a5a;
    --down-col: #4da6f5;
    --up-col: #a855f7;
    --right-col: #c9a227;
    --lane-w: 80px;
    --game-w: 380px;
    --game-h: 600px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--navy);
    color: #e8e0cc;
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ STARFIELD ‚îÄ‚îÄ */
  #stars-canvas {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position: relative;
    z-index: 10;
    width: 100%;
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(201,162,39,.2);
    background: rgba(5,10,26,.85);
    backdrop-filter: blur(8px);
  }
  .nav-brand {
    font-family: 'Orbitron', sans-serif;
    font-size: 1rem;
    letter-spacing: .2em;
    color: var(--gold);
    text-decoration: none;
  }
  .nav-back {
    font-size: .75rem;
    letter-spacing: .12em;
    color: rgba(201,162,39,.6);
    text-decoration: none;
    transition: color .2s;
  }
  .nav-back:hover { color: var(--gold); }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: relative;
    z-index: 5;
    text-align: center;
    padding: 36px 16px 20px;
  }
  header h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.6rem, 4vw, 2.6rem);
    font-weight: 900;
    letter-spacing: .15em;
    background: linear-gradient(135deg, var(--gold-light), var(--cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  header p {
    margin-top: 6px;
    font-size: .8rem;
    letter-spacing: .1em;
    color: rgba(232,224,204,.45);
  }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  #app {
    position: relative;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 0 16px 60px;
    width: 100%;
    max-width: 700px;
  }

  /* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
  #hud {
    width: var(--game-w);
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 0 4px;
  }
  .hud-block { text-align: center; }
  .hud-label {
    font-size: .6rem;
    letter-spacing: .15em;
    color: rgba(201,162,39,.5);
    margin-bottom: 2px;
  }
  .hud-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--gold-light);
  }
  #combo-display { color: var(--cyan); }
  #health-bar-wrap {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,.08);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 6px;
  }
  #health-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan), var(--gold));
    border-radius: 3px;
    transition: width .15s;
  }

  /* ‚îÄ‚îÄ GAME CANVAS WRAPPER ‚îÄ‚îÄ */
  #game-wrap {
    position: relative;
    width: var(--game-w);
    height: var(--game-h);
    background: linear-gradient(180deg, #050a1a 0%, #0a0f2a 60%, #06122b 100%);
    border: 1px solid rgba(201,162,39,.25);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 60px rgba(0,212,255,.08), 0 0 120px rgba(201,162,39,.04);
  }

  /* Lane dividers */
  .lane-div {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background: rgba(255,255,255,.06);
    z-index: 1;
  }

  /* Hit zone */
  #hit-zone {
    position: absolute;
    bottom: 80px;
    left: 0; right: 0;
    height: 2px;
    background: rgba(201,162,39,.3);
    z-index: 2;
  }

  /* Receptors */
  .receptor {
    position: absolute;
    bottom: 60px;
    width: 64px;
    height: 64px;
    z-index: 3;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    opacity: .25;
    transition: opacity .08s, transform .08s;
    border: 2px solid;
  }
  .receptor.lit { opacity: 1; transform: scale(1.12); }
  .receptor[data-lane="0"] { left: calc(25% * 0 + 4%); color: var(--left-col); border-color: var(--left-col); }
  .receptor[data-lane="1"] { left: calc(25% * 1 + 4%); color: var(--down-col); border-color: var(--down-col); }
  .receptor[data-lane="2"] { left: calc(25% * 2 + 4%); color: var(--up-col); border-color: var(--up-col); }
  .receptor[data-lane="3"] { left: calc(25% * 3 + 4%); color: var(--right-col); border-color: var(--right-col); }

  /* Game canvas */
  #game-canvas {
    position: absolute;
    inset: 0;
    z-index: 4;
  }

  /* Judgment text */
  #judgment {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Orbitron', sans-serif;
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: .1em;
    z-index: 6;
    pointer-events: none;
    opacity: 0;
    transition: opacity .15s;
    text-shadow: 0 0 20px currentColor;
  }
  #judgment.show { opacity: 1; }

  /* Particle canvas */
  #particle-canvas {
    position: absolute;
    inset: 0;
    z-index: 5;
    pointer-events: none;
  }

  /* Key guide */
  #key-guide {
    position: absolute;
    bottom: 8px;
    left: 0; right: 0;
    display: flex;
    justify-content: space-around;
    padding: 0 8px;
    z-index: 3;
  }
  .key-pill {
    width: 60px;
    text-align: center;
    font-size: .6rem;
    letter-spacing: .1em;
    color: rgba(255,255,255,.3);
    background: rgba(255,255,255,.04);
    border-radius: 3px;
    padding: 3px 0;
  }

  /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
  #controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .btn {
    font-family: 'Orbitron', sans-serif;
    font-size: .75rem;
    letter-spacing: .15em;
    padding: 10px 24px;
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--gold);
    cursor: pointer;
    border-radius: 3px;
    transition: background .2s, color .2s, box-shadow .2s;
  }
  .btn:hover, .btn.active {
    background: var(--gold);
    color: var(--navy);
    box-shadow: 0 0 20px rgba(201,162,39,.4);
  }
  .btn.primary {
    background: var(--gold);
    color: var(--navy);
    font-weight: 700;
  }
  .btn.primary:hover {
    background: var(--gold-light);
    box-shadow: 0 0 30px rgba(201,162,39,.6);
  }
  select {
    font-family: 'Space Mono', monospace;
    font-size: .7rem;
    letter-spacing: .1em;
    padding: 9px 12px;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(201,162,39,.3);
    color: var(--gold);
    border-radius: 3px;
    cursor: pointer;
    outline: none;
  }
  select:focus { border-color: var(--gold); }

  /* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
  #upload-area {
    width: var(--game-w);
    border: 2px dashed rgba(201,162,39,.25);
    border-radius: 6px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: border-color .2s, background .2s;
  }
  #upload-area:hover, #upload-area.drag-over {
    border-color: var(--gold);
    background: rgba(201,162,39,.04);
  }
  #upload-area p {
    font-size: .75rem;
    letter-spacing: .08em;
    color: rgba(232,224,204,.4);
    margin-top: 6px;
  }
  #upload-area .icon { font-size: 2rem; }
  #file-input { display: none; }
  #track-name {
    font-size: .8rem;
    color: var(--cyan);
    letter-spacing: .1em;
    min-height: 1.2em;
    text-align: center;
  }

  /* ‚îÄ‚îÄ OVERLAY (start / game over) ‚îÄ‚îÄ */
  #overlay {
    position: absolute;
    inset: 0;
    background: rgba(5,10,26,.92);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
    gap: 16px;
    transition: opacity .3s;
  }
  #overlay.hidden { opacity: 0; pointer-events: none; }
  #overlay h2 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 900;
    color: var(--gold-light);
    letter-spacing: .15em;
    text-align: center;
    padding: 0 20px;
  }
  #overlay p {
    font-size: .75rem;
    color: rgba(232,224,204,.5);
    letter-spacing: .08em;
    text-align: center;
    padding: 0 20px;
  }
  .overlay-score {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    color: var(--cyan);
  }
  .overlay-stats {
    font-size: .7rem;
    color: rgba(232,224,204,.45);
    letter-spacing: .1em;
    line-height: 1.8;
    text-align: center;
  }

  /* ‚îÄ‚îÄ INSTRUCTIONS ‚îÄ‚îÄ */
  #instructions {
    width: var(--game-w);
    background: rgba(255,255,255,.02);
    border: 1px solid rgba(201,162,39,.1);
    border-radius: 4px;
    padding: 16px;
    font-size: .7rem;
    letter-spacing: .08em;
    color: rgba(232,224,204,.4);
    line-height: 1.8;
  }
  #instructions strong { color: rgba(201,162,39,.7); }
  .key-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
  }
  .key-tag {
    padding: 2px 8px;
    border: 1px solid;
    border-radius: 3px;
    font-size: .65rem;
    letter-spacing: .05em;
  }

  @media (max-width: 440px) {
    :root { --lane-w: 70px; --game-w: 320px; }
    .receptor { width: 54px; height: 54px; font-size: 1.5rem; }
  }
</style>
</head>
<body>

<canvas id="stars-canvas"></canvas>

<nav>
  <a href="index.html" class="nav-brand">JAY JABIRU</a>
  <a href="index.html" class="nav-back">‚Üê EXPLORE</a>
</nav>

<header>
  <h1>RHYTHM STAGE</h1>
  <p>Hit the beat. Feel the orbit.</p>
</header>

<div id="app">

  <!-- Upload -->
  <div id="upload-area" onclick="document.getElementById('file-input').click()">
    <div class="icon">üéµ</div>
    <strong style="font-size:.85rem;letter-spacing:.1em;color:rgba(201,162,39,.8)">DROP YOUR TRACK</strong>
    <p>MP3 ¬∑ WAV ¬∑ OGG ‚Äî or click to browse</p>
  </div>
  <input type="file" id="file-input" accept="audio/*">
  <div id="track-name"></div>

  <!-- Controls -->
  <div id="controls">
    <select id="difficulty">
      <option value="easy">EASY</option>
      <option value="medium" selected>MEDIUM</option>
      <option value="hard">HARD</option>
    </select>
    <button class="btn primary" id="btn-start" onclick="startGame()">PLAY</button>
    <button class="btn" id="btn-restart" onclick="restartGame()" style="display:none">RETRY</button>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-block">
      <div class="hud-label">SCORE</div>
      <div class="hud-value" id="score-display">0</div>
    </div>
    <div class="hud-block">
      <div class="hud-label">COMBO</div>
      <div class="hud-value" id="combo-display">√ó0</div>
    </div>
    <div class="hud-block" style="flex:1;margin:0 16px">
      <div class="hud-label">HEALTH</div>
      <div id="health-bar-wrap"><div id="health-bar" style="width:100%"></div></div>
    </div>
  </div>

  <!-- Game -->
  <div id="game-wrap">
    <div class="lane-div" style="left:25%"></div>
    <div class="lane-div" style="left:50%"></div>
    <div class="lane-div" style="left:75%"></div>
    <div id="hit-zone"></div>

    <div class="receptor" data-lane="0">‚Üê</div>
    <div class="receptor" data-lane="1">‚Üì</div>
    <div class="receptor" data-lane="2">‚Üë</div>
    <div class="receptor" data-lane="3">‚Üí</div>

    <div id="key-guide">
      <div class="key-pill">‚Üê</div>
      <div class="key-pill">‚Üì</div>
      <div class="key-pill">‚Üë</div>
      <div class="key-pill">‚Üí</div>
    </div>

    <canvas id="game-canvas"></canvas>
    <canvas id="particle-canvas"></canvas>
    <div id="judgment"></div>

    <div id="overlay">
      <h2 id="overlay-title">RHYTHM STAGE</h2>
      <p id="overlay-sub">Upload a track, choose difficulty, and hit PLAY.</p>
      <div class="overlay-score" id="overlay-score" style="display:none"></div>
      <div class="overlay-stats" id="overlay-stats" style="display:none"></div>
      <button class="btn primary" id="overlay-btn" onclick="startGame()">BEGIN</button>
    </div>
  </div>

  <!-- Instructions -->
  <div id="instructions">
    <strong>HOW TO PLAY</strong><br>
    Notes fall from the top. Press the matching key when they reach the receptor zone at the bottom.
    <div class="key-row">
      <span class="key-tag" style="color:var(--left-col);border-color:var(--left-col)">‚Üê LEFT</span>
      <span class="key-tag" style="color:var(--down-col);border-color:var(--down-col)">‚Üì DOWN</span>
      <span class="key-tag" style="color:var(--up-col);border-color:var(--up-col)">‚Üë UP</span>
      <span class="key-tag" style="color:var(--right-col);border-color:var(--right-col)">‚Üí RIGHT</span>
    </div><br>
    The chart is <strong>auto-generated from your audio file</strong> ‚Äî peaks, beats and transients are detected and mapped to arrows. Energy levels shape the density: quieter sections stay sparse, chorus sections hit hard.
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STARFIELD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initStars() {
  const c = document.getElementById('stars-canvas');
  const ctx = c.getContext('2d');
  let stars = [];
  function resize() {
    c.width = window.innerWidth;
    c.height = window.innerHeight;
    stars = Array.from({length: 180}, () => ({
      x: Math.random() * c.width,
      y: Math.random() * c.height,
      r: Math.random() * 1.4 + .2,
      a: Math.random(),
      s: Math.random() * .004 + .001
    }));
  }
  function draw() {
    ctx.clearRect(0, 0, c.width, c.height);
    stars.forEach(s => {
      s.a += s.s;
      if (s.a > 1) { s.a = 0; s.x = Math.random()*c.width; s.y = Math.random()*c.height; }
      ctx.globalAlpha = s.a * .6;
      ctx.fillStyle = '#e8e0cc';
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
    });
    ctx.globalAlpha = 1;
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize', resize);
  resize();
  draw();
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DRAG & DROP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uploadArea = document.getElementById('upload-area');
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});
document.getElementById('file-input').addEventListener('change', e => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AUDIO ANALYSIS & CHART GENERATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioBuffer = null;
let chart = [];
let audioContext = null;
let sourceNode = null;
let startTime = 0;
let trackDuration = 0;
let trackName = '';

function handleFile(file) {
  trackName = file.name.replace(/\.[^.]+$/, '');
  document.getElementById('track-name').textContent = '‚ñ∂ ' + trackName.toUpperCase();
  const reader = new FileReader();
  reader.onload = async (e) => {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    try {
      audioBuffer = await audioContext.decodeAudioData(e.target.result);
      trackDuration = audioBuffer.duration;
      document.getElementById('overlay-sub').textContent = `${trackName.toUpperCase()} ¬∑ ${Math.floor(trackDuration/60)}:${String(Math.floor(trackDuration%60)).padStart(2,'0')} ¬∑ Choose difficulty and hit BEGIN`;
    } catch(err) {
      document.getElementById('track-name').textContent = '‚ö† Could not decode audio';
    }
  };
  reader.readAsArrayBuffer(file);
}

function generateChart(buffer, difficulty) {
  const sampleRate = buffer.sampleRate;
  const data = buffer.getChannelData(0);
  const frameSize = 1024;
  const hopSize = 512;
  const numFrames = Math.floor((data.length - frameSize) / hopSize);

  // RMS energy per frame
  const energy = new Float32Array(numFrames);
  for (let i = 0; i < numFrames; i++) {
    let sum = 0;
    const offset = i * hopSize;
    for (let j = 0; j < frameSize; j++) sum += data[offset + j] ** 2;
    energy[i] = Math.sqrt(sum / frameSize);
  }

  // Smooth energy for section detection
  const smoothed = new Float32Array(numFrames);
  const smoothWin = 30;
  for (let i = 0; i < numFrames; i++) {
    let s = 0, cnt = 0;
    for (let j = Math.max(0,i-smoothWin); j < Math.min(numFrames,i+smoothWin); j++) { s += energy[j]; cnt++; }
    smoothed[i] = s / cnt;
  }
  const maxSmooth = Math.max(...smoothed) || 1;
  const sectionEnergy = smoothed.map(v => v / maxSmooth); // 0..1

  // Onset detection (spectral flux approximation via energy diff)
  const onsets = [];
  const threshold = { easy: 0.018, medium: 0.010, hard: 0.005 }[difficulty];
  const minGap = { easy: 0.35, medium: 0.22, hard: 0.12 }[difficulty];
  let lastOnset = -999;

  for (let i = 2; i < numFrames - 1; i++) {
    const diff = energy[i] - energy[i-1];
    const sec = (i * hopSize) / sampleRate;

    // Section density gate: easy/medium skip low-energy frames some of the time
    const secE = sectionEnergy[i];
    if (difficulty === 'easy' && secE < 0.25 && Math.random() > 0.3) continue;
    if (difficulty === 'medium' && secE < 0.15 && Math.random() > 0.6) continue;

    if (diff > threshold && energy[i] > energy[i+1] && sec - lastOnset > minGap) {
      onsets.push({ time: sec, energy: energy[i], sectionE: secE });
      lastOnset = sec;
    }
  }

  // Map onsets ‚Üí chart notes with lane assignment
  const arrows = ['‚Üê','‚Üì','‚Üë','‚Üí'];
  const laneColors = ['var(--left-col)','var(--down-col)','var(--up-col)','var(--right-col)'];
  const notes = [];
  let lastLane = -1;
  let patternIdx = 0;
  // Pattern sequences for musicality
  const patterns = {
    easy:   [[0,3],[1,2],[0,1,2,3]],
    medium: [[0,1,2,3],[0,2,1,3],[3,1,2,0],[0,3,1,2]],
    hard:   [[0,1,2,3,0,2,1,3],[3,2,1,0,2,0,3,1],[0,3,2,1,0,2,3,1]]
  };
  const pat = patterns[difficulty];
  let seqI = 0, seqJ = 0;

  onsets.forEach(onset => {
    // Pick lane from pattern, avoid same lane twice on easy
    let lane;
    const seq = pat[seqI % pat.length];
    lane = seq[seqJ % seq.length];
    if (difficulty === 'easy' && lane === lastLane) lane = (lane + 2) % 4;
    seqJ++;
    if (seqJ >= seq.length) { seqJ = 0; seqI++; }
    lastLane = lane;

    notes.push({
      time: onset.time,
      lane,
      color: laneColors[lane],
      label: arrows[lane],
      hit: false,
      missed: false
    });
  });

  return notes;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GAME STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let score = 0;
let combo = 0;
let health = 100;
let gameRunning = false;
let animId = null;
let notes = [];
let particles = [];
let stats = { perfect: 0, good: 0, miss: 0 };

const KEYS = { 'arrowleft':0, 'arrowdown':1, 'arrowup':2, 'arrowright':3 };

const gameCanvas = document.getElementById('game-canvas');
const pCanvas    = document.getElementById('particle-canvas');
const gCtx = gameCanvas.getContext('2d');
const pCtx = pCanvas.getContext('2d');

function resizeCanvases() {
  const wrap = document.getElementById('game-wrap');
  // Force a layout flush before reading dimensions
  const w = wrap.getBoundingClientRect().width;
  const h = wrap.getBoundingClientRect().height;
  if (w > 0 && h > 0) {
    gameCanvas.width = pCanvas.width = Math.floor(w);
    gameCanvas.height = pCanvas.height = Math.floor(h);
  }
}

const LANE_W = 80;
const NOTE_H = 24;
const HIT_Y_FRAC = (h) => h - 96; // pixels from top where receptor centre sits
const TRAVEL_TIME = 1.8; // seconds for note to traverse visible area
const PERFECT_WIN = 0.06;
const GOOD_WIN = 0.13;

function laneX(lane, canvasW) {
  const lw = canvasW / 4;
  const noteW = lw * 0.78;
  return lane * lw + (lw - noteW) / 2;
}

function noteWidth(canvasW) {
  return (canvasW / 4) * 0.78;
}

function noteY(note, now, canvasH) {
  const hitY = HIT_Y_FRAC(canvasH);
  const dt = note.time - now;
  return hitY - (dt / TRAVEL_TIME) * hitY;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PARTICLES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 4 + 1;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 2,
      life: 1,
      decay: Math.random() * 0.04 + 0.02,
      r: Math.random() * 4 + 2,
      color
    });
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  JUDGMENT DISPLAY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let judgmentTimeout = null;
function showJudgment(text, color) {
  const el = document.getElementById('judgment');
  el.textContent = text;
  el.style.color = color;
  el.classList.add('show');
  if (judgmentTimeout) clearTimeout(judgmentTimeout);
  judgmentTimeout = setTimeout(() => el.classList.remove('show'), 400);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RECEPTOR FLASH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flashReceptor(lane) {
  const r = document.querySelector(`.receptor[data-lane="${lane}"]`);
  r.classList.add('lit');
  setTimeout(() => r.classList.remove('lit'), 100);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  UPDATE DISPLAYS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHUD() {
  document.getElementById('score-display').textContent = score.toLocaleString();
  document.getElementById('combo-display').textContent = '√ó' + combo;
  document.getElementById('health-bar').style.width = health + '%';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KEY HANDLER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onKeyDown(e) {
  if (!gameRunning) return;
  const lane = KEYS[e.key.toLowerCase()];
  if (lane === undefined) return;
  e.preventDefault();
  flashReceptor(lane);

  const now = audioContext.currentTime - startTime;
  const canvasH = gameCanvas.height;
  const ly = HIT_Y_FRAC(canvasH);

  // Find closest unhit note in this lane
  let best = null, bestDist = Infinity;
  notes.forEach(n => {
    if (n.lane !== lane || n.hit || n.missed) return;
    const dist = Math.abs(n.time - now);
    if (dist < bestDist) { bestDist = dist; best = n; }
  });

  if (!best) return;

  if (bestDist <= PERFECT_WIN) {
    best.hit = true;
    combo++;
    const pts = 300 * Math.min(combo, 10);
    score += pts;
    health = Math.min(100, health + 2);
    stats.perfect++;
    showJudgment('PERFECT', '#f0c84a');
    const px = laneX(lane, gameCanvas.width) + noteWidth(gameCanvas.width) / 2;
    spawnParticles(px, ly, best.color, 18);
  } else if (bestDist <= GOOD_WIN) {
    best.hit = true;
    combo++;
    score += 100;
    health = Math.min(100, health + 1);
    stats.good++;
    showJudgment('GOOD', '#4da6f5');
    const px = laneX(lane, gameCanvas.width) + noteWidth(gameCanvas.width) / 2;
    spawnParticles(px, ly, best.color, 8);
  } else {
    // Early press on far-future note: ignore
  }
  updateHUD();
}
document.addEventListener('keydown', onKeyDown);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GAME LOOP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gameLoop() {
  if (!gameRunning) return;

  const now = audioContext.currentTime - startTime;
  const canvasW = gameCanvas.width;
  const canvasH = gameCanvas.height;

  // Miss detection
  notes.forEach(n => {
    if (!n.hit && !n.missed && n.time < now - GOOD_WIN) {
      n.missed = true;
      combo = 0;
      health = Math.max(0, health - 8);
      stats.miss++;
      showJudgment('MISS', '#ff4444');
      updateHUD();
    }
  });

  // Clear
  gCtx.clearRect(0, 0, canvasW, canvasH);
  pCtx.clearRect(0, 0, canvasW, canvasH);

  // Lane highlight lines
  for (let i = 0; i < 4; i++) {
    const lc = ['rgba(240,90,90,.03)','rgba(77,166,245,.03)','rgba(168,85,247,.03)','rgba(201,162,39,.03)'][i];
    gCtx.fillStyle = lc;
    gCtx.fillRect(i*LANE_W + 8, 0, LANE_W - 8, canvasH);
  }

  // Notes
  const hitY = HIT_Y_FRAC(canvasH);
  notes.forEach(n => {
    if (n.hit || n.missed) return;
    const y = noteY(n, now, canvasH);
    if (y < -NOTE_H || y > canvasH + NOTE_H) return;

    const x = laneX(n.lane, canvasW);
    const w = noteWidth(canvasW);
    const h = NOTE_H;
    const r = 6;

    // Glow
    const grd = gCtx.createRadialGradient(x+w/2, y+h/2, 2, x+w/2, y+h/2, w);
    grd.addColorStop(0, n.color.replace('var(', '').replace(')', ''));

    // Arrow body
    gCtx.save();
    gCtx.shadowColor = n.color.replace('var(--left-col)','#f05a5a')
                                .replace('var(--down-col)','#4da6f5')
                                .replace('var(--up-col)','#a855f7')
                                .replace('var(--right-col)','#c9a227');
    gCtx.shadowBlur = 12;

    // Rounded rect
    gCtx.beginPath();
    gCtx.moveTo(x+r, y); gCtx.lineTo(x+w-r, y);
    gCtx.quadraticCurveTo(x+w,y,x+w,y+r);
    gCtx.lineTo(x+w,y+h-r); gCtx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    gCtx.lineTo(x+r,y+h); gCtx.quadraticCurveTo(x,y+h,x,y+h-r);
    gCtx.lineTo(x,y+r); gCtx.quadraticCurveTo(x,y,x+r,y);
    gCtx.closePath();

    const resolvedColor = n.color.replace('var(--left-col)','#f05a5a')
                                   .replace('var(--down-col)','#4da6f5')
                                   .replace('var(--up-col)','#a855f7')
                                   .replace('var(--right-col)','#c9a227');
    gCtx.fillStyle = resolvedColor + '33';
    gCtx.fill();
    gCtx.strokeStyle = resolvedColor;
    gCtx.lineWidth = 2;
    gCtx.stroke();

    // Arrow text
    gCtx.font = `bold ${h+2}px Arial`;
    gCtx.fillStyle = resolvedColor;
    gCtx.textAlign = 'center';
    gCtx.textBaseline = 'middle';
    gCtx.fillText(n.label, x+w/2, y+h/2+1);
    gCtx.restore();
  });

  // Particles
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x += p.vx; p.y += p.vy;
    p.vy += 0.15;
    p.life -= p.decay;
    const col = p.color.replace('var(--left-col)','#f05a5a')
                        .replace('var(--down-col)','#4da6f5')
                        .replace('var(--up-col)','#a855f7')
                        .replace('var(--right-col)','#c9a227');
    pCtx.globalAlpha = p.life;
    pCtx.fillStyle = col;
    pCtx.beginPath();
    pCtx.arc(p.x, p.y, p.r * p.life, 0, Math.PI*2);
    pCtx.fill();
  });
  pCtx.globalAlpha = 1;

  // End check
  if (now > trackDuration + 2 || (health <= 0)) {
    endGame();
    return;
  }

  animId = requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  START / END
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame() {
  if (!audioBuffer) {
    alert('Please upload a music file first.');
    return;
  }
  if (sourceNode) { try { sourceNode.stop(); } catch(e){} }

  resizeCanvases();

  const diff = document.getElementById('difficulty').value;
  notes = generateChart(audioBuffer, diff);
  particles = [];
  score = 0; combo = 0; health = 100;
  stats = { perfect:0, good:0, miss:0 };
  updateHUD();

  // Hide overlay
  const overlay = document.getElementById('overlay');
  overlay.classList.add('hidden');

  document.getElementById('btn-start').style.display = 'none';
  document.getElementById('btn-restart').style.display = 'inline-block';

  // Play audio
  if (audioContext.state === 'suspended') audioContext.resume();
  sourceNode = audioContext.createBufferSource();
  sourceNode.buffer = audioBuffer;
  sourceNode.connect(audioContext.destination);
  startTime = audioContext.currentTime;
  sourceNode.start(0);
  sourceNode.onended = () => { if (gameRunning) endGame(); };

  gameRunning = true;
  if (animId) cancelAnimationFrame(animId);
  gameLoop();
}

function restartGame() {
  gameRunning = false;
  if (animId) cancelAnimationFrame(animId);
  startGame();
}

function endGame() {
  gameRunning = false;
  if (animId) cancelAnimationFrame(animId);
  try { sourceNode && sourceNode.stop(); } catch(e) {}

  const overlay = document.getElementById('overlay');
  const total = stats.perfect + stats.good + stats.miss;
  const acc = total > 0 ? Math.round((stats.perfect + stats.good*0.5) / total * 100) : 0;

  document.getElementById('overlay-title').textContent = health <= 0 ? 'STAGE FAILED' : 'CLEAR';
  document.getElementById('overlay-sub').textContent = health <= 0 ? 'Health depleted. Try again.' : trackName.toUpperCase();
  document.getElementById('overlay-score').style.display = 'block';
  document.getElementById('overlay-score').textContent = score.toLocaleString();
  document.getElementById('overlay-stats').style.display = 'block';
  document.getElementById('overlay-stats').innerHTML =
    `PERFECT ${stats.perfect} &nbsp;¬∑&nbsp; GOOD ${stats.good} &nbsp;¬∑&nbsp; MISS ${stats.miss}<br>ACCURACY ${acc}%`;
  document.getElementById('overlay-btn').textContent = 'PLAY AGAIN';
  document.getElementById('overlay-btn').onclick = restartGame;
  overlay.classList.remove('hidden');
}

// Initial resize ‚Äî defer to ensure layout is painted
window.addEventListener('load', () => { resizeCanvases(); });
setTimeout(resizeCanvases, 100);
window.addEventListener('resize', resizeCanvases);
</script>
</body>
</html>
