<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jay Jabiru â€” Sokoban</title>
  <link rel="icon" href="logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="levels.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy:      #05080f;
      --navy2:     #0a0f1e;
      --navy3:     #111827;
      --blue:      #4a7fff;
      --blue-dim:  #2a4fa0;
      --blue-glow: rgba(74,127,255,0.35);
      --gold:      #c8a84b;
      --gold-dim:  #7a6425;
      --gold-glow: rgba(200,168,75,0.3);
      --white:     #e8eeff;
      --muted:     #6b7a9a;
    }

    html, body {
      height: 100%;
      background: var(--navy);
      color: var(--white);
      font-family: 'Raleway', sans-serif;
      overflow-x: hidden;
    }

    #stars-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    #app {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* â”€â”€ HEADER â”€â”€ */
    #site-header {
      width: 100%;
      padding: 18px 36px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(74,127,255,0.18);
      background: rgba(5,8,15,0.8);
      backdrop-filter: blur(12px);
    }

    #site-header .logo-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }

    #site-header img.logo {
      height: 38px;
      filter: drop-shadow(0 0 8px var(--blue-glow));
    }

    #site-header .site-name {
      font-family: 'Cinzel', serif;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--white);
    }

    #site-header .back-link {
      font-family: 'Raleway', sans-serif;
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--blue);
      text-decoration: none;
      border: 1px solid var(--blue-dim);
      padding: 6px 16px;
      border-radius: 3px;
      transition: all 0.2s;
    }

    #site-header .back-link:hover {
      background: rgba(74,127,255,0.15);
      box-shadow: 0 0 12px var(--blue-glow);
    }

    /* â”€â”€ TITLE â”€â”€ */
    #title-block {
      text-align: center;
      padding: 36px 20px 20px;
      animation: float-in 0.7s ease both;
    }

    #title-block .eyebrow {
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 10px;
    }

    #title-block h1 {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.6rem, 4vw, 2.8rem);
      font-weight: 900;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, var(--white) 30%, var(--blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1;
    }

    #title-block .tagline {
      font-size: 0.82rem;
      color: var(--muted);
      letter-spacing: 0.06em;
      margin-top: 8px;
    }

    /* â”€â”€ HUD â”€â”€ */
    #hud {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 10px 24px;
      background: rgba(10,15,30,0.7);
      border: 1px solid rgba(74,127,255,0.2);
      border-radius: 8px;
      margin-bottom: 16px;
      backdrop-filter: blur(8px);
      flex-wrap: wrap;
      justify-content: center;
      animation: float-in 0.7s 0.15s ease both;
    }

    .hud-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .hud-label {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .hud-value {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
      min-width: 2.5ch;
      text-align: center;
    }

    #level-name-display {
      font-family: 'Cinzel', serif;
      font-size: 0.9rem;
      color: var(--blue);
      letter-spacing: 0.08em;
      text-align: center;
      flex: 1 1 100%;
    }

    #level-desc-display {
      font-size: 0.72rem;
      color: var(--muted);
      letter-spacing: 0.05em;
      text-align: center;
      flex: 1 1 100%;
      margin-top: -6px;
    }

    /* â”€â”€ GAME â”€â”€ */
    #game-wrap {
      position: relative;
      margin: 0 auto;
      animation: float-in 0.7s 0.25s ease both;
    }

    #game-canvas {
      display: block;
      border-radius: 10px;
      border: 1px solid rgba(74,127,255,0.25);
      box-shadow:
        0 0 40px rgba(74,127,255,0.12),
        0 0 80px rgba(74,127,255,0.06),
        inset 0 0 20px rgba(0,0,0,0.5);
      cursor: default;
    }

    /* â”€â”€ CONTROLS â”€â”€ */
    #controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
      justify-content: center;
      animation: float-in 0.7s 0.35s ease both;
    }

    .btn {
      font-family: 'Cinzel', serif;
      font-size: 0.72rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 9px 20px;
      border-radius: 4px;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
    }

    .btn-blue  { border-color: var(--blue); color: var(--blue); }
    .btn-blue:hover  { background: rgba(74,127,255,0.15); box-shadow: 0 0 16px var(--blue-glow); }
    .btn-gold  { border-color: var(--gold); color: var(--gold); }
    .btn-gold:hover  { background: rgba(200,168,75,0.12); box-shadow: 0 0 16px var(--gold-glow); }
    .btn-muted { border-color: var(--muted); color: var(--muted); font-size: 0.65rem; }
    .btn-muted:hover { border-color: var(--white); color: var(--white); }

    /* â”€â”€ KEY HINT â”€â”€ */
    #key-hint {
      margin-top: 12px;
      font-size: 0.65rem;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-align: center;
    }

    /* â”€â”€ LEVEL PIPS â”€â”€ */
    #level-select {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 600px;
    }

    .level-pip {
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(74,127,255,0.25);
      border-radius: 4px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.18s;
      background: rgba(10,15,30,0.5);
    }

    .level-pip.active  { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 10px var(--gold-glow); }
    .level-pip.cleared { border-color: var(--blue); color: var(--blue); background: rgba(74,127,255,0.08); }
    .level-pip.locked  { opacity: 0.3; cursor: default; }

    /* â”€â”€ WIN OVERLAY â”€â”€ */
    #win-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(5,8,15,0.88);
      border-radius: 10px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      backdrop-filter: blur(4px);
      z-index: 10;
    }

    #win-overlay.show { display: flex; }

    #win-overlay .win-title {
      font-family: 'Cinzel', serif;
      font-size: 2rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--gold), var(--white));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: pulse-glow 1.5s ease-in-out infinite;
    }

    #win-overlay .win-sub { font-size: 0.8rem; color: var(--muted); letter-spacing: 0.1em; }

    #win-overlay .win-stats { display: flex; gap: 28px; }

    .win-stat { text-align: center; }
    .win-stat-val { font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--blue); }
    .win-stat-lbl { font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); }

    /* â”€â”€ MUSIC BAR â”€â”€ */
    #music-bar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    #music-panel {
      display: none;
      flex-direction: column;
      gap: 6px;
      background: rgba(5,8,15,0.92);
      border: 1px solid rgba(74,127,255,0.3);
      border-radius: 8px;
      padding: 12px 16px;
      backdrop-filter: blur(12px);
      min-width: 200px;
    }

    #music-panel.open { display: flex; }

    .music-panel-title {
      font-family: 'Cinzel', serif;
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .track-btn {
      font-family: 'Raleway', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.06em;
      padding: 7px 12px;
      border-radius: 4px;
      border: 1px solid rgba(74,127,255,0.25);
      color: var(--muted);
      background: transparent;
      cursor: pointer;
      transition: all 0.18s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .track-btn:hover { border-color: var(--blue); color: var(--white); }
    .track-btn.playing { border-color: var(--gold); color: var(--gold); }

    .track-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .track-btn.playing .track-dot { background: var(--gold); box-shadow: 0 0 6px var(--gold-glow); }

    .music-divider {
      height: 1px;
      background: rgba(74,127,255,0.15);
      margin: 4px 0;
    }

    #mute-btn {
      font-family: 'Raleway', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      padding: 7px 12px;
      border-radius: 4px;
      border: 1px solid rgba(200,168,75,0.3);
      color: var(--muted);
      background: transparent;
      cursor: pointer;
      transition: all 0.18s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    #mute-btn:hover { border-color: var(--gold); color: var(--gold); }
    #mute-btn.muted { color: var(--gold); border-color: var(--gold); }

    #music-toggle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--blue-dim);
      background: rgba(10,15,30,0.9);
      color: var(--blue);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
    }

    #music-toggle:hover { box-shadow: 0 0 16px var(--blue-glow); border-color: var(--blue); }
    #music-toggle.active { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 12px var(--gold-glow); }

    /* â”€â”€ MOBILE DPAD â”€â”€ */
    #dpad {
      display: none;
      margin-top: 16px;
      grid-template-columns: repeat(3, 52px);
      grid-template-rows: repeat(3, 52px);
      gap: 4px;
      justify-content: center;
    }

    @media (max-width: 600px) {
      #dpad { display: grid; }
    }

    .dpad-btn {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(74,127,255,0.1);
      border: 1px solid rgba(74,127,255,0.3);
      border-radius: 6px;
      color: var(--blue);
      cursor: pointer;
      user-select: none;
      transition: background 0.1s;
      -webkit-tap-highlight-color: transparent;
    }

    .dpad-btn:active { background: rgba(74,127,255,0.3); }
    .dpad-blank { background: transparent; border-color: transparent; pointer-events: none; }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.75; }
    }

    @keyframes float-in {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* â”€â”€ FOOTER â”€â”€ */
    #footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
    }
  </style>
</head>

<body>

<canvas id="stars-canvas"></canvas>

<!-- AUDIO ELEMENTS -->
<audio id="track1" loop preload="auto" src="stellar1.mp3"></audio>
<audio id="track2" loop preload="auto" src="stellar2.mp3"></audio>

<div id="app">

  <header id="site-header">
    <a class="logo-wrap" href="index.html">
      <img class="logo" src="logo.png" alt="Jay Jabiru Logo" onerror="this.style.display='none'" />
      <span class="site-name">Jay Jabiru</span>
    </a>
    <a class="back-link" href="index.html">â† Back to Site</a>
  </header>

  <div id="title-block">
    <div class="eyebrow">Puzzle Game</div>
    <h1>Stellar Push</h1>
    <div class="tagline">Navigate the void. Move the crates. Find your orbit.</div>
  </div>

  <div id="hud">
    <div id="level-name-display">â€”</div>
    <div id="level-desc-display">â€”</div>
    <div class="hud-item">
      <span class="hud-label">Level</span>
      <span class="hud-value" id="hud-level">1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Moves</span>
      <span class="hud-value" id="hud-moves">0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Pushes</span>
      <span class="hud-value" id="hud-pushes">0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Crates</span>
      <span class="hud-value" id="hud-crates">0/0</span>
    </div>
  </div>

  <div id="game-wrap">
    <canvas id="game-canvas"></canvas>
    <div id="win-overlay">
      <div class="win-title">âœ¦ Solved âœ¦</div>
      <div class="win-sub" id="win-level-name"></div>
      <div class="win-stats">
        <div class="win-stat">
          <div class="win-stat-val" id="win-moves">0</div>
          <div class="win-stat-lbl">Moves</div>
        </div>
        <div class="win-stat">
          <div class="win-stat-val" id="win-pushes">0</div>
          <div class="win-stat-lbl">Pushes</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-top:8px">
        <button class="btn btn-gold" id="btn-next-win">Next Level</button>
        <button class="btn btn-blue" id="btn-replay-win">Replay</button>
      </div>
    </div>
  </div>

  <div id="controls">
    <button class="btn btn-gold" id="btn-prev">â—€ Prev</button>
    <button class="btn btn-blue" id="btn-restart">â†º Restart</button>
    <button class="btn btn-gold" id="btn-next">Next â–¶</button>
    <button class="btn btn-muted" id="btn-undo">Undo</button>
  </div>

  <div id="dpad">
    <div class="dpad-blank"></div>
    <button class="dpad-btn" id="dpad-up">â–²</button>
    <div class="dpad-blank"></div>
    <button class="dpad-btn" id="dpad-left">â—€</button>
    <div class="dpad-blank"></div>
    <button class="dpad-btn" id="dpad-right">â–¶</button>
    <div class="dpad-blank"></div>
    <button class="dpad-btn" id="dpad-down">â–¼</button>
    <div class="dpad-blank"></div>
  </div>

  <div id="key-hint">Arrow keys or WASD to move Â· Z to undo Â· R to restart</div>

  <div id="level-select"></div>

  <div id="footer">Jay Jabiru Â· Stellar Push Â· A Sokoban Experience</div>

</div>

<!-- MUSIC BAR -->
<div id="music-bar">
  <div id="music-panel">
    <div class="music-panel-title">ğŸµ Music</div>

    <button class="track-btn" id="play-track1">
      <span class="track-dot"></span>
      Stellar 1
    </button>
    <button class="track-btn" id="play-track2">
      <span class="track-dot"></span>
      Stellar 2
    </button>

    <div class="music-divider"></div>

    <button id="mute-btn">
      <span id="mute-icon">ğŸ”Š</span>
      <span id="mute-label">Mute</span>
    </button>
  </div>

  <button id="music-toggle" title="Music">ğŸµ</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STARFIELD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  const canvas = document.getElementById('stars-canvas');
  const ctx = canvas.getContext('2d');
  let stars = [];

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function initStars() {
    stars = [];
    const n = Math.floor((canvas.width * canvas.height) / 3000);
    for (let i = 0; i < n; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 1.4 + 0.2,
        a: Math.random(),
        da: (Math.random() - 0.5) * 0.005,
        speed: Math.random() * 0.04 + 0.01,
      });
    }
  }

  function drawStars() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(s => {
      s.a += s.da;
      if (s.a > 1) { s.a = 1; s.da *= -1; }
      if (s.a < 0.1) { s.a = 0.1; s.da *= -1; }
      s.y += s.speed;
      if (s.y > canvas.height) { s.y = 0; s.x = Math.random() * canvas.width; }
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(180,200,255,${s.a})`;
      ctx.fill();
    });
    requestAnimationFrame(drawStars);
  }

  window.addEventListener('resize', () => { resize(); initStars(); });
  resize();
  initStars();
  drawStars();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MUSIC SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const track1El = document.getElementById('track1');
const track2El = document.getElementById('track2');
const musicToggle  = document.getElementById('music-toggle');
const musicPanel   = document.getElementById('music-panel');
const muteBtn      = document.getElementById('mute-btn');
const muteIcon     = document.getElementById('mute-icon');
const muteLabel    = document.getElementById('mute-label');
const playTrack1Btn = document.getElementById('play-track1');
const playTrack2Btn = document.getElementById('play-track2');

let currentTrack = null; // track1El or track2El
let muted = false;
let panelOpen = false;

function stopAll() {
  track1El.pause(); track1El.currentTime = 0;
  track2El.pause(); track2El.currentTime = 0;
  playTrack1Btn.classList.remove('playing');
  playTrack2Btn.classList.remove('playing');
  musicToggle.classList.remove('active');
  currentTrack = null;
}

function playTrack(el, btn) {
  stopAll();
  if (!muted) {
    el.volume = 0.4;
    el.play().catch(() => {});
  }
  currentTrack = el;
  btn.classList.add('playing');
  musicToggle.classList.add('active');
}

function toggleMute() {
  muted = !muted;
  if (muted) {
    if (currentTrack) currentTrack.pause();
    muteIcon.textContent = 'ğŸ”‡';
    muteLabel.textContent = 'Unmute';
    muteBtn.classList.add('muted');
    musicToggle.textContent = 'ğŸ”‡';
  } else {
    if (currentTrack) currentTrack.play().catch(() => {});
    muteIcon.textContent = 'ğŸ”Š';
    muteLabel.textContent = 'Mute';
    muteBtn.classList.remove('muted');
    musicToggle.textContent = 'ğŸµ';
  }
}

function togglePanel() {
  panelOpen = !panelOpen;
  musicPanel.classList.toggle('open', panelOpen);
}

musicToggle.addEventListener('click', togglePanel);
muteBtn.addEventListener('click', toggleMute);
playTrack1Btn.addEventListener('click', () => { getAudioCtx(); playTrack(track1El, playTrack1Btn); });
playTrack2Btn.addEventListener('click', () => { getAudioCtx(); playTrack(track2El, playTrack2Btn); });

// Close panel if clicking outside
document.addEventListener('click', e => {
  if (panelOpen && !document.getElementById('music-bar').contains(e.target)) {
    panelOpen = false;
    musicPanel.classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEB AUDIO â€” ATMOSPHERIC SFX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTone(freq, type, duration, vol, attack, detune) {
  const ctx = getAudioCtx();
  const osc    = ctx.createOscillator();
  const gain   = ctx.createGain();
  const filter = ctx.createBiquadFilter();

  filter.type = 'lowpass';
  filter.frequency.value = freq * 3;
  filter.Q.value = 2;

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(ctx.destination);

  osc.type = type;
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  if (detune) osc.detune.setValueAtTime(detune, ctx.currentTime);

  gain.gain.setValueAtTime(0, ctx.currentTime);
  gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + attack);
  gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);

  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + duration + 0.05);
}

function sfxMove()    { playTone(180,'sine',0.12,0.06,0.005,0); playTone(240,'sine',0.10,0.03,0.005,5); }
function sfxWall()    { playTone(60,'sawtooth',0.08,0.05,0.003,0); }
function sfxUndo()    { playTone(300,'sine',0.1,0.04,0.003,0); setTimeout(()=>playTone(220,'sine',0.1,0.04,0.003,0),60); }
function sfxPush()    { playTone(120,'sawtooth',0.18,0.08,0.008,0); playTone(160,'sine',0.18,0.05,0.005,-3); setTimeout(()=>playTone(200,'sine',0.12,0.04,0.003,0),40); }
function sfxBoxOnGoal() { [440,554,659,880].forEach((f,i) => setTimeout(()=>{ playTone(f,'sine',0.35,0.07,0.01,0); playTone(f*2,'sine',0.3,0.03,0.01,7); },i*60)); }
function sfxWin()     { [523,659,784,1047,784,1047,1319].forEach((f,i) => setTimeout(()=>{ playTone(f,'sine',0.45,0.1,0.01,0); playTone(f*1.5,'triangle',0.35,0.04,0.01,0); },i*110)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOKOBAN ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TILE = { WALL:'#', FLOOR:' ', GOAL:'.', BOX:'$', BOX_GOAL:'*', PLAYER:'@', PLAYER_GOAL:'+' };

function parseLevel(map) {
  const rows = map.split('\n');
  const grid = rows.map(row => row.split(''));
  let player = null;
  const boxes = [], goals = [];

  for (let r = 0; r < grid.length; r++) {
    for (let c = 0; c < (grid[r] ? grid[r].length : 0); c++) {
      const ch = grid[r][c];
      if (ch === TILE.PLAYER || ch === TILE.PLAYER_GOAL) {
        player = { r, c };
        grid[r][c] = (ch === TILE.PLAYER_GOAL) ? TILE.GOAL : TILE.FLOOR;
      }
      if (ch === TILE.BOX || ch === TILE.BOX_GOAL) {
        boxes.push({ r, c });
        grid[r][c] = (ch === TILE.BOX_GOAL) ? TILE.GOAL : TILE.FLOOR;
      }
      if ([TILE.GOAL, TILE.BOX_GOAL, TILE.PLAYER_GOAL].includes(ch)) {
        if (!goals.find(g => g.r===r && g.c===c)) goals.push({ r, c });
      }
    }
  }

  return { grid, player, boxes, goals, rows: grid.length, cols: Math.max(...grid.map(r=>r?r.length:0)) };
}

function isWall(grid, r, c) { return !grid[r] || grid[r][c] === undefined || grid[r][c] === TILE.WALL; }
function isBox(boxes, r, c) { return boxes.some(b => b.r===r && b.c===c); }
function isGoal(goals, r, c) { return goals.some(g => g.r===r && g.c===c); }
function isSolved(boxes, goals) { return goals.every(g => isBox(boxes, g.r, g.c)); }
function cloneState(s) { return { player: {...s.player}, boxes: s.boxes.map(b=>({...b})) }; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentLevelIdx = 0;
let levelData = null, player = null, boxes = [], goals = [], grid = null;
let moves = 0, pushes = 0, history = [], solved = false;
let clearedLevels = new Set();

const canvas = document.getElementById('game-canvas');
const ctx    = canvas.getContext('2d');

function loadLevel(idx) {
  if (!ACTIVE_LEVELS[idx]) return;
  currentLevelIdx = idx;
  solved = false;

  const parsed = parseLevel(ACTIVE_LEVELS[idx].map);
  levelData = parsed;
  grid   = parsed.grid;
  player = { ...parsed.player };
  boxes  = parsed.boxes.map(b => ({...b}));
  goals  = parsed.goals;
  moves = 0; pushes = 0; history = [];

  document.getElementById('hud-level').textContent       = idx + 1;
  document.getElementById('level-name-display').textContent = ACTIVE_LEVELS[idx].name;
  document.getElementById('level-desc-display').textContent = ACTIVE_LEVELS[idx].description;

  resizeCanvas();
  updateHUD();
  document.getElementById('win-overlay').classList.remove('show');
  refreshLevelPips();
  draw();
}

function getCellSize() {
  const maxW = Math.min(window.innerWidth - 40, 680);
  const maxH = window.innerHeight * 0.52;
  const cols = levelData ? levelData.cols : 10;
  const rows = levelData ? levelData.rows : 10;
  return Math.max(22, Math.min(56, Math.floor(Math.min(maxW/cols, maxH/rows))));
}

function resizeCanvas() {
  if (!levelData) return;
  const cs = getCellSize();
  canvas.width  = levelData.cols * cs;
  canvas.height = levelData.rows * cs;
}

function updateHUD() {
  document.getElementById('hud-moves').textContent  = moves;
  document.getElementById('hud-pushes').textContent = pushes;
  const onGoal = boxes.filter(b => isGoal(goals, b.r, b.c)).length;
  document.getElementById('hud-crates').textContent = `${onGoal}/${goals.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function drawRoundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function draw() {
  if (!levelData) return;
  const cs = getCellSize();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#070c18';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const rows = levelData.rows, cols = levelData.cols;

  for (let r = 0; r < rows; r++) {
    const row = grid[r] || [];
    for (let c = 0; c < cols; c++) {
      const ch = row[c] || ' ';
      const x = c * cs, y = r * cs;

      if (ch === TILE.WALL) {
        const grad = ctx.createLinearGradient(x, y, x+cs, y+cs);
        grad.addColorStop(0, '#1a2445');
        grad.addColorStop(1, '#0e1530');
        ctx.fillStyle = grad;
        ctx.fillRect(x, y, cs, cs);
        ctx.strokeStyle = 'rgba(74,127,255,0.18)';
        ctx.lineWidth = 1;
        ctx.strokeRect(x+0.5, y+0.5, cs-1, cs-1);
        [[3,3],[cs-5,3],[3,cs-5],[cs-5,cs-5]].forEach(([rx,ry]) => {
          ctx.beginPath(); ctx.arc(x+rx, y+ry, 1.2, 0, Math.PI*2);
          ctx.fillStyle = 'rgba(74,127,255,0.35)'; ctx.fill();
        });
      } else {
        ctx.fillStyle = (r+c)%2===0 ? '#080d1a' : '#0a1020';
        ctx.fillRect(x, y, cs, cs);

        if (ch === TILE.GOAL) {
          ctx.save();
          ctx.shadowColor = '#c8a84b'; ctx.shadowBlur = 10;
          ctx.strokeStyle = 'rgba(200,168,75,0.7)'; ctx.lineWidth = 1.5;
          const cx=x+cs/2, cy=y+cs/2, s=cs*0.28;
          ctx.beginPath();
          ctx.moveTo(cx,cy-s); ctx.lineTo(cx+s,cy); ctx.lineTo(cx,cy+s); ctx.lineTo(cx-s,cy);
          ctx.closePath(); ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(cx,cy-s*0.55); ctx.lineTo(cx,cy+s*0.55);
          ctx.moveTo(cx-s*0.55,cy); ctx.lineTo(cx+s*0.55,cy);
          ctx.stroke(); ctx.restore();
        }
      }
    }
  }

  // Boxes
  boxes.forEach(b => {
    const x=b.c*cs, y=b.r*cs, onGoal=isGoal(goals,b.r,b.c);
    const pad=cs*0.1, size=cs-pad*2;
    ctx.save();
    ctx.shadowColor = onGoal ? '#4a7fff' : '#c8a84b';
    ctx.shadowBlur  = onGoal ? 16 : 8;
    const grad = ctx.createLinearGradient(x+pad,y+pad,x+pad+size,y+pad+size);
    grad.addColorStop(0, onGoal ? '#1a4a30' : '#7a5010');
    grad.addColorStop(1, onGoal ? '#0d2a1a' : '#4a3008');
    drawRoundRect(ctx, x+pad, y+pad, size, size, 4);
    ctx.fillStyle = grad; ctx.fill();
    ctx.strokeStyle = onGoal ? 'rgba(74,127,255,0.9)' : 'rgba(200,168,75,0.8)';
    ctx.lineWidth = 1.5; ctx.stroke();
    const cx=x+cs/2, cy=y+cs/2, s=size*0.22;
    ctx.strokeStyle = onGoal ? 'rgba(74,127,255,0.6)' : 'rgba(200,168,75,0.5)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(cx,cy-s); ctx.lineTo(cx+s,cy); ctx.lineTo(cx,cy+s); ctx.lineTo(cx-s,cy);
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  });

  // Player
  {
    const x=player.c*cs, y=player.r*cs;
    const cx=x+cs/2, cy=y+cs/2, r=cs*0.32;
    ctx.save();
    ctx.shadowColor = '#4a7fff'; ctx.shadowBlur = 20;
    const grad = ctx.createRadialGradient(cx-r*0.2, cy-r*0.2, 0, cx, cy, r);
    grad.addColorStop(0, '#6090ff'); grad.addColorStop(0.5, '#3060cc'); grad.addColorStop(1, '#1a2060');
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.fillStyle = grad; ctx.fill();
    ctx.strokeStyle = 'rgba(150,200,255,0.9)'; ctx.lineWidth = 1.5; ctx.stroke();
    ctx.fillStyle = 'rgba(180,220,255,0.7)';
    ctx.beginPath(); ctx.ellipse(cx, cy-r*0.18, r*0.28, r*0.16, -0.3, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'rgba(74,127,255,0.25)'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(cx, cy, r*1.35, 0, Math.PI*2); ctx.stroke();
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DIR = { up:{dr:-1,dc:0}, down:{dr:1,dc:0}, left:{dr:0,dc:-1}, right:{dr:0,dc:1} };

function move(dir) {
  if (solved) return;
  const {dr,dc} = DIR[dir];
  const nr=player.r+dr, nc=player.c+dc;

  if (isWall(grid,nr,nc)) { sfxWall(); return; }

  if (isBox(boxes,nr,nc)) {
    const bnr=nr+dr, bnc=nc+dc;
    if (isWall(grid,bnr,bnc) || isBox(boxes,bnr,bnc)) { sfxWall(); return; }
    history.push(cloneState({player,boxes}));
    const bi = boxes.findIndex(b=>b.r===nr&&b.c===nc);
    boxes[bi].r=bnr; boxes[bi].c=bnc;
    player.r=nr; player.c=nc;
    pushes++; moves++;
    sfxPush();
    if (isGoal(goals,bnr,bnc)) setTimeout(sfxBoxOnGoal, 80);
  } else {
    history.push(cloneState({player,boxes}));
    player.r=nr; player.c=nc;
    moves++;
    sfxMove();
  }

  updateHUD();
  draw();

  if (isSolved(boxes,goals)) {
    solved = true;
    clearedLevels.add(currentLevelIdx);
    refreshLevelPips();
    setTimeout(() => { sfxWin(); showWin(); }, 200);
  }
}

function undo() {
  if (!history.length) return;
  sfxUndo();
  const prev = history.pop();
  player = prev.player; boxes = prev.boxes;
  moves = Math.max(0, moves-1);
  updateHUD(); draw();
}

function showWin() {
  document.getElementById('win-level-name').textContent = ACTIVE_LEVELS[currentLevelIdx].name;
  document.getElementById('win-moves').textContent  = moves;
  document.getElementById('win-pushes').textContent = pushes;
  document.getElementById('win-overlay').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVEL PIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function refreshLevelPips() {
  const wrap = document.getElementById('level-select');
  wrap.innerHTML = '';
  for (let i = 0; i < 10; i++) {
    const pip = document.createElement('div');
    pip.className = 'level-pip';
    pip.textContent = i + 1;
    const active = ACTIVE_LEVELS[i] !== undefined;
    if (!active) {
      pip.classList.add('locked');
      pip.title = 'Coming soon';
    } else {
      if (i === currentLevelIdx) pip.classList.add('active');
      if (clearedLevels.has(i)) pip.classList.add('cleared');
      pip.addEventListener('click', () => { getAudioCtx(); loadLevel(i); });
    }
    wrap.appendChild(pip);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('keydown', e => {
  getAudioCtx();
  const map = {
    'ArrowUp':'up','w':'up','W':'up',
    'ArrowDown':'down','s':'down','S':'down',
    'ArrowLeft':'left','a':'left','A':'left',
    'ArrowRight':'right','d':'right','D':'right',
  };
  if (map[e.key]) { e.preventDefault(); move(map[e.key]); }
  if (e.key==='z'||e.key==='Z') { e.preventDefault(); undo(); }
  if (e.key==='r'||e.key==='R') { e.preventDefault(); loadLevel(currentLevelIdx); }
});

document.getElementById('btn-restart').addEventListener('click', () => { getAudioCtx(); loadLevel(currentLevelIdx); });
document.getElementById('btn-next').addEventListener('click', () => { getAudioCtx(); if (currentLevelIdx < ACTIVE_LEVELS.length-1) loadLevel(currentLevelIdx+1); });
document.getElementById('btn-prev').addEventListener('click', () => { getAudioCtx(); if (currentLevelIdx > 0) loadLevel(currentLevelIdx-1); });
document.getElementById('btn-undo').addEventListener('click', () => { getAudioCtx(); undo(); });
document.getElementById('btn-next-win').addEventListener('click', () => { getAudioCtx(); if (currentLevelIdx < ACTIVE_LEVELS.length-1) loadLevel(currentLevelIdx+1); else document.getElementById('win-overlay').classList.remove('show'); });
document.getElementById('btn-replay-win').addEventListener('click', () => { getAudioCtx(); loadLevel(currentLevelIdx); });

['up','down','left','right'].forEach(dir => {
  document.getElementById(`dpad-${dir}`).addEventListener('click', () => { getAudioCtx(); move(dir); });
});

window.addEventListener('resize', () => { if (levelData) { resizeCanvas(); draw(); } });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('load', () => {
  if (typeof ACTIVE_LEVELS !== 'undefined' && ACTIVE_LEVELS.length > 0) {
    loadLevel(0);
  } else {
    canvas.parentElement.innerHTML = '<p style="color:#6b7a9a;padding:40px;text-align:center;font-family:Raleway,sans-serif;">No levels loaded. Check levels.js</p>';
  }
});
</script>
</body>
</html>
